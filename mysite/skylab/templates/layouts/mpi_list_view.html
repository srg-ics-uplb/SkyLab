{% extends 'layouts/base.html' %}
{% load staticfiles %}

{% block title %}{{ block.super }}MPI Clusters{% endblock %}

{% block css_imports %}
    <link rel="stylesheet" href="{% static 'dataTables/css/dataTables.bootstrap.min.css' %}">
{% endblock %}

{% block navbar_breadcrumb %}
    <ol class="breadcrumb">
        <li>
            <a href="{% url 'skylab-home' %}">Home</a>
        </li>
        <li class="active">
            MPI Clusters
        </li>
    </ol>
{% endblock %}

{% block content %}





    <div class="row">
        <h1>MPI Clusters</h1>
        <table id="mpi-table"
               class="clickable-table table table-hover table-responsive table-striped table-bordered dataTable">
            <thead>
            <tr>
                <th>Cluster name</th>
                <th>Nodes</th>
                <th>IP address</th>
                <th>Tasks queued</th>
                <th>Status</th>
                <th>Visibility</th>
                <th>Date created</th>

            </tr>
            </thead>
            <tbody id="mpi-table-body">
{#            {% for cluster in mpi_clusters %}#}
                {#        <div class='row'>#}
{#                <tr>#}
{#                    <td>{{ cluster.id }}</td>#}
{#                    <td>{{ cluster.cluster_name }}</td>#}
{#                    <td>{{ cluster.total_node_count }}</td>#}
{#                    <td>{{ cluster.cluster_ip }}</td>#}
{#                    <td>{{ cluster.task_queued_count }}</td>#}
{#                    <td>#}
{#                        {{ cluster.current_simple_status_msg }} {% if cluster.queued_for_deletion %}(Scheduled for#}
{#                        deletion){% endif %}#}
{#                    </td>#}
                    {#                    <td>{{ cluster.created }}</td>#}
{#                    <td>{% if cluster.is_public %}Public {% else %} Private {% endif %} </td>#}
{#                </tr>#}
                {#        </div>#}
{#            {% endfor %}#}
            </tbody>
        </table>
    </div>
    <div class="row">
        <a class="btn btn-primary" href="{% url 'create_mpi' %}">Create MPI cluster</a>
        <button id="add-cluster-btn" type="button" class="btn btn-success" data-toggle="modal"
                data-target="#enter-share-key-modal"><i class="fa fa-plus" aria-hidden="true"></i>
            Add private cluster
        </button>

    </div>
    {#  enter share key modal   #}
    <div class="modal fade" id="enter-share-key-modal" role="dialog">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header bg-success">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Add Private Cluster</h4>
                </div>
                <div id="modal-allow-user-to-mpi" class="modal-body">
                    <input name="share-key" type="text" class="form-control" placeholder="Enter share key">
                    <p class="help-block">You will be granted access to the cluster with the matching key.</p>
                </div>
                <div class="modal-footer ">

                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addUserToCluster()">Add
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}



{% block js %}
    <script type="text/javascript" src="{% static 'dataTables/js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'dataTables/js/dataTables.bootstrap.min.js' %}"></script>
    <script>
        {# for sorting status msg #}
        $.fn.dataTable.ext.type.detect.unshift(
                function (d) {
                    return d === 'Creating' || d === 'Connecting' || d === 'Online' || d === 'Connection error' ?
                            'mpi-status' :
                            null;
                }
        );
        $.fn.dataTable.ext.type.order['mpi-status-pre'] = function (d) {
            switch (d) {
                case 'Creating':
                    return 0;
                case 'Connecting':
                    return 1;
                case 'Online':
                    return 2;
                case 'Connection error':
                    return 3;
                default:
                    return 0;
            }

        };

        {# dataTable object init #}
        var table = $('#mpi-table').DataTable({
            "columnDefs": [
                {
                    "targets": [4], {# status column #}
                    "createdCell": function (td, cellData, rowData, row, col) { {# add bootstrap txt-class to status column #}
                        var patt = /.+for\s+deletion/i;
                        $(td).removeClass();
                        if (patt.test(cellData)) { {# check if for deletion #}
                            $(td).addClass('text-warning')
                        } else {
                            switch (cellData) {
                                case "Online":
                                    $(td).addClass('text-success');
                                    break;
                                case "Connection error":
                                    $(td).addClass('text-danger');
                                    break;
                                default:
                                    $(td).addClass('text-info');
                            }
                        }
                    }
                },
            ],
            "createdRow": function (row, data, dataIndex) { {# on row created #}
                $(row).addClass('clickable-row');
                {# make row clickable #}
                {# reference: http://stackoverflow.com/questions/17832194/get-javascript-variables-value-in-django-url-template-tag #}
                {#                var url_mask = "{% url 'mpi_detail_view' pk=911 %}".replace(/911/, data[0]);#}
                var url_mask = "{% url 'mpi_detail_view' cluster_name='cluster_name_placeholder' %}".replace(/cluster_name_placeholder/, data[0]);
                {# parse url #}
                $(row).attr('data-href', url_mask);
            }
        });

        var refreshMPITable = function(){
             ajaxGet('{% url 'ajax_refresh_mpi_list_table' %}', function (content) {
                table.clear();
                table.rows.add(content.rows).draw();
            })
        };
        refreshMPITable();
        setInterval( refreshMPITable, 10000);


        $(document).ready(function () {
            $("tbody").on('click', 'tr', function () { {# make table row clickable #}
                window.location = $(this).data("href");
                {# go to cluster detail view #}
            });
        });

        var addUserToCluster = function () {
            var share_key_form = $('input[type=text][name=share-key]');
            var share_key = share_key_form.val();
            share_key_form.val('');
            ajaxPost('{% url 'ajax_post_allow_user_access_to_mpi' %}', {
                'share_key': share_key
            }, function (content) {
                if (content.error === 'true') {
                    $('#modal-allow-user-to-mpi').prepend('<div class="alert alert-danger"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>Error!</strong> Found no matching cluster.</div>')
                } else if (content.error === 'false') {
                    $('#enter-share-key-modal').modal('toggle');
                    {#                    uncomment these lines if you just want to refresh table on cluster add           #}
                    {#                    table.clear();#}
                    {#                    table.rows.add(content.rows).draw();#}
                    window.location = "{% url 'mpi_detail_view' cluster_name='cluster_name_placeholder' %}".replace(/cluster_name_placeholder/, content.cluster_name);
                }
            })
        };

    </script>


{% endblock %}
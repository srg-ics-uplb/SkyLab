{% extends 'layouts/base.html' %}
{% load staticfiles %}

{% block title %}{{ block.super }}Tasks{% endblock %}

{% block css_imports %}
    <link rel="stylesheet" href="{% static 'dataTables/css/dataTables.bootstrap.min.css' %}">
{% endblock %}

{% block content %}
    <div class="row">
        <h1 class="text-center">Tasks</h1>
    </div>
        <div class='row'>
            <table id="task-list-table"
                   class="table table-hover table-responsive table-striped table-bordered dataTable">
                <thead>
                <tr>
                    <th>Task number</th>
                    <th>Tool</th>
                    <th>MPI Cluster</th>
                    <th>Task status</th>
                    <th>Last updated</th>
                </tr>
                </thead>
                <tbody>
                {% for task in tasks %}
                    <tr>
                        <td>{{ task.id }}</td>
                        <td>{{ task.tool }} ({{ task.tool.toolset.display_name }})</td>
                        <td>{{ task.mpi_cluster.cluster_name }}</td>
                        <td>{{ task.simple_status_msg }}</td>
                        <td>{{ task.updated }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    <div class="row">
        <button id="add-task-btn" class="btn btn-success" data-toggle="modal"
                data-target="#create-task-modal"><i class="fa fa-plus" aria-hidden="true"></i>
            Create new task
        </button>
        </div>
    {#  confirm delete modal   #}
    <div class="modal fade" id="create-task-modal" role="dialog">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Create New Task</h4>
                </div>
                <div id="modal-allow-user-to-mpi" class="modal-body">
                    <div class="alert alert-danger fade in" id="form-error" style="display:none;">
                        <button type="button" class="close">Ã—</button>
                        Please select a toolset, then select a tool.
                    </div>
                    <div class="form-group">
                        <label for="toolset-select">Toolset:</label>
                        <select id="toolset-select" class="form-control"></select>
                    </div>

                    <div class="form-group">
                        <label for="tool-select">Tool:</label>
                        <select id="tool-select" class="form-control"></select>
                    </div>
                    <p class="help-block">Select the tool you want to use.</p>
                </div>
                <div class="modal-footer ">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="redirectToSelectedTool()">Ok
                    </button>
                </div>
            </div>
        </div>
    </div>


{% endblock %}

{% block js %}
    <script type="text/javascript" src="{% static 'dataTables/js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'dataTables/js/dataTables.bootstrap.min.js' %}"></script>
    <script>
        $(document).ready(function () {
            $(".clickable-row").click(function () { {# make table row clickable #}
                window.location = $(this).data("href");
                {# go to task detail view #}
            });
        });

        var table = $('#task-list-table').DataTable({
            "columnDefs": [
                {
                    "targets": [3], {# status column #}
                    "createdCell": function (td, cellData, rowData, row, col) { {# add bootstrap txt-class to status column #}

                        $(td).removeClass();
                        switch (cellData) {
                            case "Online":
                                $(td).addClass('text-success');
                                break;
                            case "Connection error":
                                $(td).addClass('text-danger');
                                break;
                            default:
                                $(td).addClass('text-info');
                        }

                    }
                }

            ],
            "createdRow": function (row, data, dataIndex) { {# on row created #}
                $(row).addClass('clickable-row');

                {# make row clickable #}
                {# reference: http://stackoverflow.com/questions/17832194/get-javascript-variables-value-in-django-url-template-tag #}
                var url_mask = "{% url 'task_detail_view' pk=911 %}".replace(/911/, data[0]);
                {# parse url #}
                $(row).attr('data-href', url_mask);
            }
        });

        $('#add-task-btn').click(function () { {# refresh toolset list on modal activate #}
            ajaxGet('{% url 'ajax_refresh_select_toolset'%}', function (content) {
                $('#toolset-select').prop('selectedIndex', -1)
            })
        });

        $('#toolset-select').change(function () {
            var url_mask = "{% url 'ajax_refresh_select_tool' pk=911 %}".replace(/911/, $('#toolset-select').val());
            ajaxGet(url_mask, function (content) {
                $('#tool-select').prop('selectedIndex', -1)
            });
        });

        var redirectToSelectedTool = function () {
            if ($('#tool-select').val() != null) {
                var url_mask = "{% url 'ajax_refresh_select_tool' pk=911 %}".replace(/911/, data[0]);
                {#                todo : dynamic url for tool#}
            }
        }


    </script>

{% endblock %}
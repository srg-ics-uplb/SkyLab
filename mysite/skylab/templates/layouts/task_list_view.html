{% extends 'layouts/base.html' %}
{% load staticfiles %}

{% block title %}{{ block.super }}Tasks{% endblock %}

{% block css_imports %}
    <link rel="stylesheet" href="{% static 'dataTables/css/dataTables.bootstrap.min.css' %}">
{% endblock %}

{% block navbar_breadcrumb %}
    <ol class="breadcrumb">
        <li>
            <a href="{% url 'skylab-home' %}">Home</a>
        </li>
        <li class="active">
            Tasks
        </li>
    </ol>

{% endblock %}

{% block content %}


    <div class='row'>
        <h1>Tasks</h1>

        <table id="task-list-table"
                   class="table table-hover table-responsive table-striped table-bordered dataTable">
                <thead>
                <tr>
                    <th>Task number</th>
                    <th>Tool</th>
                    <th>MPI Cluster</th>
                    <th>Task status</th>
                    <th>Date created</th>
                    <th>Last updated</th>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>

    <div class="row">
        <button id="add-task-btn" class="btn btn-primary" data-toggle="modal"
                data-target="#create-task-modal"><i class="fa fa-plus" aria-hidden="true"></i>
            Create new task
        </button>
        </div>


{% endblock %}

{% block js %}
    <script type="text/javascript" src="{% static 'dataTables/js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'dataTables/js/dataTables.bootstrap.min.js' %}"></script>

    <script>
        $(function () {
              $("tbody").on('click','tr', function () { {# make table row clickable #}
                window.location = $(this).data("href");
                {# go to task detail view #}
            });
            var table = $('#task-list-table').DataTable({
                "order": [],
                "columnDefs": [
                    {
                        "targets": [3], {# status column #}
                        "createdCell": function (td, cellData, rowData, row, col) { {# add bootstrap txt-class to status column #}

                            $(td).removeClass();
                            switch (cellData) {
                                case "Online":
                                    $(td).addClass('text-success');
                                    break;
                                case "Connection error":
                                    $(td).addClass('text-danger');
                                    break;
                                default:
                                    $(td).addClass('text-info');
                            }

                        }
                    }

                ],
                "createdRow": function (row, data, dataIndex) { {# on row created #}
                    $(row).addClass('clickable-row');

                    {# make row clickable #}
                    {# reference: http://stackoverflow.com/questions/17832194/get-javascript-variables-value-in-django-url-template-tag #}
                    var url_mask = "{% url 'task_detail_view' pk=911 %}".replace(/911/, data[0]);
                    {# parse url #}
                    $(row).attr('data-href', url_mask);
                }
            });



            var refreshTaskTable = function(){ {# refresh task table #}
                 ajaxGet('{% url 'ajax_refresh_task_list_table' %}', function (content) {
                    table.clear();
                    table.rows.add(content.rows).draw();
                })
            };
            refreshTaskTable();
            setInterval(refreshTaskTable, 10000); {# refresh data every 10 secs #}
        });







    </script>

{% endblock %}